<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AAT Dashboard</title>
<style>
  :root {
    --bg-primary: #1a1a2e;
    --bg-secondary: #16213e;
    --bg-card: #0f3460;
    --text-primary: #e0e0e0;
    --text-secondary: #a0a0b0;
    --accent: #00d4aa;
    --accent-hover: #00f0c0;
    --danger: #e74c3c;
    --warning: #f39c12;
    --success: #00d4aa;
    --border: #2a2a4a;
    --radius: 8px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
  }

  /* Header */
  .header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    padding: 12px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .header h1 { font-size: 18px; font-weight: 600; }
  .header h1 span { color: var(--accent); }
  .header-status {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 13px;
  }
  .status-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--danger);
    display: inline-block;
  }
  .status-dot.connected { background: var(--success); }

  /* Layout */
  .layout {
    display: grid;
    grid-template-columns: 280px 1fr 360px;
    grid-template-rows: 1fr 1fr;
    gap: 1px;
    height: calc(100vh - 49px);
    background: var(--border);
  }

  .panel {
    background: var(--bg-primary);
    overflow-y: auto;
    padding: 16px;
  }
  .panel-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-secondary);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  /* Panel: Server (left top) */
  .p-server { grid-row: 1; grid-column: 1; }

  /* Panel: Config (left bottom) */
  .p-config { grid-row: 2; grid-column: 1; }

  /* Panel: Execution (center) */
  .p-execution { grid-row: 1 / 3; grid-column: 2; }

  /* Panel: Screenshot (right top) */
  .p-screenshot { grid-row: 1; grid-column: 3; }

  /* Panel: Log (right bottom) */
  .p-log { grid-row: 2; grid-column: 3; }

  /* Buttons */
  .btn {
    padding: 8px 16px;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: background 0.2s;
  }
  .btn-primary {
    background: var(--accent);
    color: var(--bg-primary);
  }
  .btn-primary:hover { background: var(--accent-hover); }
  .btn-danger {
    background: var(--danger);
    color: white;
  }
  .btn-danger:hover { opacity: 0.9; }
  .btn-sm { padding: 5px 10px; font-size: 12px; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-group { display: flex; gap: 8px; margin-top: 12px; }

  /* Inputs */
  .input {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text-primary);
    padding: 6px 10px;
    font-size: 13px;
    width: 100%;
  }
  .input:focus { outline: none; border-color: var(--accent); }
  .field { margin-bottom: 10px; }
  .field label {
    display: block;
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 4px;
  }
  select.input { appearance: auto; }

  /* Scenario list */
  .scenario-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 10px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  .scenario-item:hover { border-color: var(--accent); }
  .scenario-item.selected { border-color: var(--accent); background: var(--bg-card); }
  .scenario-id { font-size: 11px; color: var(--accent); font-weight: 600; }
  .scenario-name { font-size: 13px; margin-top: 2px; }
  .scenario-meta { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }

  /* Progress bar */
  .progress-container {
    background: var(--bg-secondary);
    border-radius: var(--radius);
    height: 24px;
    overflow: hidden;
    margin-bottom: 16px;
    position: relative;
  }
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #00b894);
    transition: width 0.3s ease;
    border-radius: var(--radius);
  }
  .progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 11px;
    font-weight: 600;
    color: var(--text-primary);
  }

  /* Step results */
  .step-list { list-style: none; }
  .step-item {
    background: var(--bg-secondary);
    border-radius: var(--radius);
    padding: 10px 12px;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    border-left: 3px solid var(--border);
  }
  .step-item.passed { border-left-color: var(--success); }
  .step-item.failed { border-left-color: var(--danger); }
  .step-item.running { border-left-color: var(--warning); }
  .step-badge {
    font-size: 11px;
    font-weight: 700;
    min-width: 20px;
    text-align: center;
  }
  .step-badge.passed { color: var(--success); }
  .step-badge.failed { color: var(--danger); }
  .step-badge.running { color: var(--warning); }
  .step-desc { flex: 1; }
  .step-error {
    font-size: 11px;
    color: var(--danger);
    margin-top: 4px;
    padding-left: 30px;
  }

  /* Screenshot viewer */
  .screenshot-container {
    background: var(--bg-secondary);
    border-radius: var(--radius);
    overflow: hidden;
    text-align: center;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .screenshot-container img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius);
  }
  .screenshot-placeholder {
    color: var(--text-secondary);
    font-size: 13px;
  }

  /* Log panel */
  .log-area {
    background: var(--bg-secondary);
    border-radius: var(--radius);
    padding: 10px;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 11px;
    line-height: 1.6;
    max-height: calc(100% - 40px);
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-all;
  }
  .log-info { color: var(--text-primary); }
  .log-success { color: var(--success); }
  .log-warning { color: var(--warning); }
  .log-error { color: var(--danger); }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }
  .modal h3 {
    font-size: 16px;
    margin-bottom: 16px;
    color: var(--accent);
  }
  .modal-context {
    background: var(--bg-primary);
    border-radius: var(--radius);
    padding: 12px;
    margin-bottom: 16px;
    font-size: 13px;
    line-height: 1.5;
    max-height: 300px;
    overflow-y: auto;
  }
  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }

  /* Responsive */
  @media (max-width: 1100px) {
    .layout {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto;
    }
    .p-server { grid-row: 1; grid-column: 1; }
    .p-config { grid-row: 1; grid-column: 2; }
    .p-execution { grid-row: 2; grid-column: 1 / 3; }
    .p-screenshot { grid-row: 3; grid-column: 1; }
    .p-log { grid-row: 3; grid-column: 2; }
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <h1><span>AAT</span> Dashboard</h1>
  <div class="header-status">
    <span id="wsStatus">Disconnected</span>
    <span class="status-dot" id="wsDot"></span>
  </div>
</div>

<!-- 5-Panel Layout -->
<div class="layout">

  <!-- Panel: Server -->
  <div class="panel p-server">
    <div class="panel-title">Scenarios</div>
    <div id="scenarioList">
      <div style="color: var(--text-secondary); font-size: 13px;">Loading...</div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary btn-sm" onclick="loadScenarios()">Refresh</button>
    </div>
  </div>

  <!-- Panel: Config -->
  <div class="panel p-config">
    <div class="panel-title">Configuration</div>
    <div class="field">
      <label>Engine Type</label>
      <select class="input" id="cfgEngine">
        <option value="web">web</option>
        <option value="desktop">desktop</option>
      </select>
    </div>
    <div class="field">
      <label>Browser</label>
      <select class="input" id="cfgBrowser">
        <option value="chromium">chromium</option>
        <option value="firefox">firefox</option>
        <option value="webkit">webkit</option>
      </select>
    </div>
    <div class="field">
      <label>Headless</label>
      <select class="input" id="cfgHeadless">
        <option value="false">No</option>
        <option value="true">Yes</option>
      </select>
    </div>
    <div class="field">
      <label>AI Provider</label>
      <select class="input" id="cfgProvider">
        <option value="claude">claude</option>
        <option value="openai">openai</option>
        <option value="ollama">ollama</option>
      </select>
    </div>
    <div class="field">
      <label>Model</label>
      <input class="input" id="cfgModel" value="">
    </div>
    <div class="field">
      <label>API Key</label>
      <input class="input" id="cfgApiKey" type="password" placeholder="***">
    </div>
    <div class="field">
      <label>Target URL</label>
      <input class="input" id="cfgUrl" value="">
    </div>
    <div class="field">
      <label>Approval Mode</label>
      <select class="input" id="cfgApproval">
        <option value="manual">manual</option>
        <option value="branch">branch</option>
        <option value="auto">auto</option>
      </select>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary btn-sm" onclick="saveConfig()">Save Config</button>
    </div>
  </div>

  <!-- Panel: Execution (center) -->
  <div class="panel p-execution">
    <div class="panel-title">Execution</div>

    <!-- Controls -->
    <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
      <button class="btn btn-primary" id="btnRun" onclick="startRun()">Run Test</button>
      <button class="btn btn-primary" id="btnLoop" onclick="startLoop()">DevQA Loop</button>
      <button class="btn btn-danger" id="btnStop" onclick="stopRun()" disabled>Stop</button>
    </div>

    <!-- Progress -->
    <div class="progress-container" id="progressContainer" style="display: none;">
      <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      <div class="progress-text" id="progressText">0 / 0</div>
    </div>

    <!-- Step Results -->
    <ul class="step-list" id="stepList"></ul>

    <!-- Summary -->
    <div id="summary" style="display: none; margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius);"></div>
  </div>

  <!-- Panel: Live Screenshot -->
  <div class="panel p-screenshot">
    <div class="panel-title">Live Screenshot</div>
    <div class="screenshot-container" id="screenshotBox">
      <div class="screenshot-placeholder">No screenshot yet</div>
    </div>
  </div>

  <!-- Panel: Event Log -->
  <div class="panel p-log">
    <div class="panel-title">Event Log</div>
    <div class="log-area" id="logArea"></div>
  </div>

</div>

<!-- Approval Modal -->
<div class="modal-overlay" id="approvalModal">
  <div class="modal">
    <h3>AI Fix Approval</h3>
    <div class="modal-context" id="approvalContext"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="resolvePrompt('approve')">Approve</button>
      <button class="btn btn-danger" onclick="resolvePrompt('deny')">Deny</button>
      <button class="btn btn-primary" onclick="resolvePrompt('approve_all')" style="background: #0f3460; color: var(--accent); border: 1px solid var(--accent);">Approve All</button>
    </div>
  </div>
</div>

<script>
// -- State --
let ws = null;
let isRunning = false;
let selectedScenarios = new Set();

// -- WebSocket --
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);

  ws.onopen = () => {
    document.getElementById('wsStatus').textContent = 'Connected';
    document.getElementById('wsDot').classList.add('connected');
    addLog('info', 'WebSocket connected');
  };

  ws.onclose = () => {
    document.getElementById('wsStatus').textContent = 'Disconnected';
    document.getElementById('wsDot').classList.remove('connected');
    addLog('warning', 'WebSocket disconnected, reconnecting...');
    setTimeout(connectWS, 3000);
  };

  ws.onerror = () => {
    addLog('error', 'WebSocket error');
  };

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    handleEvent(data);
  };

  // Ping keepalive
  setInterval(() => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'ping' }));
    }
  }, 30000);
}

function handleEvent(data) {
  switch (data.type) {
    case 'info':
      addLog('info', data.message);
      break;
    case 'success':
      addLog('success', data.message);
      break;
    case 'warning':
      addLog('warning', data.message);
      break;
    case 'error':
      addLog('error', data.message);
      break;
    case 'step_start':
      addStepRunning(data.step, data.total, data.description);
      break;
    case 'step_result':
      updateStepResult(data.step, data.passed, data.description, data.error);
      break;
    case 'progress':
      updateProgress(data.current, data.total, data.label);
      break;
    case 'screenshot':
      updateScreenshot(data.data);
      break;
    case 'section':
      addLog('info', `--- ${data.message || data.text} ---`);
      break;
    case 'prompt':
      showApprovalModal(data.question, data.options, data.context);
      break;
    case 'run_start':
    case 'loop_start':
      setRunning(true);
      clearSteps();
      break;
    case 'run_complete':
    case 'loop_complete':
      setRunning(false);
      if (data.success !== undefined) {
        showSummary(data);
      }
      break;
    case 'run_cancelled':
    case 'loop_cancelled':
      setRunning(false);
      addLog('warning', 'Execution cancelled');
      break;
    case 'run_error':
    case 'loop_error':
      setRunning(false);
      addLog('error', data.error || 'Unknown error');
      break;
    case 'pong':
      break;
    default:
      addLog('info', JSON.stringify(data));
  }
}

// -- Log --
function addLog(level, message) {
  const area = document.getElementById('logArea');
  const line = document.createElement('div');
  line.className = `log-${level}`;
  const time = new Date().toLocaleTimeString();
  line.textContent = `[${time}] ${message}`;
  area.appendChild(line);
  area.scrollTop = area.scrollHeight;
}

// -- Steps --
function clearSteps() {
  document.getElementById('stepList').innerHTML = '';
  document.getElementById('summary').style.display = 'none';
  const pc = document.getElementById('progressContainer');
  pc.style.display = 'block';
  updateProgress(0, 1, 'Starting...');
}

function addStepRunning(step, total, description) {
  const list = document.getElementById('stepList');
  // Remove existing running item for this step
  const existing = document.getElementById(`step-${step}`);
  if (existing) existing.remove();

  const li = document.createElement('li');
  li.className = 'step-item running';
  li.id = `step-${step}`;
  li.innerHTML = `
    <span class="step-badge running">${step}</span>
    <span class="step-desc">${escHtml(description)}</span>
    <span style="color: var(--warning); font-size: 11px;">running...</span>
  `;
  list.appendChild(li);
  li.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function updateStepResult(step, passed, description, error) {
  const existing = document.getElementById(`step-${step}`);
  const status = passed ? 'passed' : 'failed';
  const badge = passed ? 'OK' : 'FAIL';

  if (existing) {
    existing.className = `step-item ${status}`;
    existing.innerHTML = `
      <span class="step-badge ${status}">${badge}</span>
      <span class="step-desc">${escHtml(description)}</span>
    `;
    if (error) {
      const errDiv = document.createElement('div');
      errDiv.className = 'step-error';
      errDiv.textContent = error;
      existing.appendChild(errDiv);
    }
  } else {
    const list = document.getElementById('stepList');
    const li = document.createElement('li');
    li.className = `step-item ${status}`;
    li.id = `step-${step}`;
    li.innerHTML = `
      <span class="step-badge ${status}">${badge}</span>
      <span class="step-desc">${escHtml(description)}</span>
    `;
    if (error) {
      const errDiv = document.createElement('div');
      errDiv.className = 'step-error';
      errDiv.textContent = error;
      li.appendChild(errDiv);
    }
    list.appendChild(li);
  }
}

// -- Progress --
function updateProgress(current, total, label) {
  const pct = total > 0 ? Math.round((current / total) * 100) : 0;
  document.getElementById('progressBar').style.width = `${pct}%`;
  document.getElementById('progressText').textContent = `${current} / ${total} â€” ${label || ''}`;
  document.getElementById('progressContainer').style.display = 'block';
}

// -- Screenshot --
function updateScreenshot(base64Data) {
  const box = document.getElementById('screenshotBox');
  box.innerHTML = `<img src="data:image/jpeg;base64,${base64Data}" alt="Live screenshot">`;
}

// -- Summary --
function showSummary(data) {
  const div = document.getElementById('summary');
  const status = data.success ? 'SUCCESS' : 'FAILURE';
  const color = data.success ? 'var(--success)' : 'var(--danger)';
  div.innerHTML = `
    <div style="font-size: 15px; font-weight: 700; color: ${color}; margin-bottom: 8px;">${status}</div>
    ${data.iterations ? `<div style="font-size: 13px;">Iterations: ${data.iterations}</div>` : ''}
    ${data.duration_ms ? `<div style="font-size: 13px;">Duration: ${Math.round(data.duration_ms)}ms</div>` : ''}
    ${data.reason ? `<div style="font-size: 13px; color: var(--text-secondary);">Reason: ${data.reason}</div>` : ''}
  `;
  div.style.display = 'block';
}

// -- Approval Modal --
function showApprovalModal(question, options, context) {
  document.getElementById('approvalContext').textContent =
    context?.analysis || question || 'Approve this fix?';
  document.getElementById('approvalModal').classList.add('active');
}

function resolvePrompt(response) {
  document.getElementById('approvalModal').classList.remove('active');
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'prompt_response', response: response }));
  }
}

// -- Running state --
function setRunning(running) {
  isRunning = running;
  document.getElementById('btnRun').disabled = running;
  document.getElementById('btnLoop').disabled = running;
  document.getElementById('btnStop').disabled = !running;
}

// -- API Calls --
async function loadConfig() {
  try {
    const res = await fetch('/api/config');
    const data = await res.json();
    if (data.engine) {
      document.getElementById('cfgEngine').value = data.engine.type || 'web';
      document.getElementById('cfgBrowser').value = data.engine.browser || 'chromium';
      document.getElementById('cfgHeadless').value = String(data.engine.headless || false);
    }
    if (data.ai) {
      document.getElementById('cfgProvider').value = data.ai.provider || 'claude';
      document.getElementById('cfgModel').value = data.ai.model || '';
      document.getElementById('cfgApiKey').placeholder = data.ai.api_key || '***';
    }
    document.getElementById('cfgUrl').value = data.url || '';
    document.getElementById('cfgApproval').value = data.approval_mode || 'manual';
  } catch (e) {
    addLog('error', `Failed to load config: ${e.message}`);
  }
}

async function saveConfig() {
  const body = {
    engine: {
      type: document.getElementById('cfgEngine').value,
      browser: document.getElementById('cfgBrowser').value,
      headless: document.getElementById('cfgHeadless').value === 'true',
    },
    ai: {
      provider: document.getElementById('cfgProvider').value,
      model: document.getElementById('cfgModel').value,
    },
    url: document.getElementById('cfgUrl').value,
    approval_mode: document.getElementById('cfgApproval').value,
  };
  // Only include API key if user typed something
  const apiKey = document.getElementById('cfgApiKey').value;
  if (apiKey) body.ai.api_key = apiKey;

  try {
    const res = await fetch('/api/config', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await res.json();
    if (data.error) {
      addLog('error', `Config save failed: ${data.error}`);
    } else {
      addLog('success', 'Config saved');
      loadConfig();
    }
  } catch (e) {
    addLog('error', `Config save failed: ${e.message}`);
  }
}

async function loadScenarios() {
  try {
    const res = await fetch('/api/scenarios');
    const data = await res.json();
    const list = document.getElementById('scenarioList');
    if (!data.scenarios || data.scenarios.length === 0) {
      list.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px;">No scenarios found</div>';
      return;
    }
    list.innerHTML = '';
    data.scenarios.forEach(sc => {
      const div = document.createElement('div');
      div.className = 'scenario-item' + (selectedScenarios.has(sc.id) ? ' selected' : '');
      div.innerHTML = `
        <div class="scenario-id">${escHtml(sc.id)}</div>
        <div class="scenario-name">${escHtml(sc.name)}</div>
        <div class="scenario-meta">${sc.steps_count} steps${sc.tags.length ? ' | ' + sc.tags.join(', ') : ''}</div>
      `;
      div.onclick = () => {
        if (selectedScenarios.has(sc.id)) {
          selectedScenarios.delete(sc.id);
          div.classList.remove('selected');
        } else {
          selectedScenarios.add(sc.id);
          div.classList.add('selected');
        }
      };
      list.appendChild(div);
    });
    if (data.error) {
      addLog('warning', data.error);
    }
  } catch (e) {
    addLog('error', `Failed to load scenarios: ${e.message}`);
  }
}

async function startRun() {
  try {
    const res = await fetch('/api/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({}),
    });
    const data = await res.json();
    if (data.error) {
      addLog('error', data.error);
    } else {
      addLog('info', 'Test run started');
    }
  } catch (e) {
    addLog('error', `Failed to start run: ${e.message}`);
  }
}

async function startLoop() {
  const approvalMode = document.getElementById('cfgApproval').value;
  try {
    const res = await fetch('/api/loop', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ approval_mode: approvalMode }),
    });
    const data = await res.json();
    if (data.error) {
      addLog('error', data.error);
    } else {
      addLog('info', 'DevQA Loop started');
    }
  } catch (e) {
    addLog('error', `Failed to start loop: ${e.message}`);
  }
}

async function stopRun() {
  try {
    await fetch('/api/stop', { method: 'POST' });
    addLog('warning', 'Stop requested');
  } catch (e) {
    addLog('error', `Failed to stop: ${e.message}`);
  }
}

function escHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

// -- Init --
document.addEventListener('DOMContentLoaded', () => {
  connectWS();
  loadConfig();
  loadScenarios();
});
</script>
</body>
</html>
