<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AAT ëŒ€ì‹œë³´ë“œ</title>
<style>
  :root {
    --bg-primary: #1a1a2e;
    --bg-secondary: #16213e;
    --bg-card: #0f3460;
    --text-primary: #e0e0e0;
    --text-secondary: #a0a0b0;
    --accent: #00d4aa;
    --accent-hover: #00f0c0;
    --danger: #e74c3c;
    --warning: #f39c12;
    --success: #00d4aa;
    --border: #2a2a4a;
    --radius: 6px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 13px;
    height: 100vh;
    overflow: hidden;
  }

  /* Header */
  .header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    padding: 6px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 36px;
  }
  .header h1 { font-size: 15px; font-weight: 600; }
  .header h1 span { color: var(--accent); }
  .header-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
  }
  .status-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--danger);
    display: inline-block;
  }
  .status-dot.connected { background: var(--success); }

  /* Layout: 3-step Z-pattern filling viewport */
  .layout {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 36px);
    gap: 1px;
    background: var(--border);
  }

  .top-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
    flex-shrink: 0;
  }

  .bottom-row {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg-primary);
    min-height: 0;
  }

  .panel {
    background: var(--bg-primary);
    overflow-y: auto;
    padding: 8px 12px;
  }

  .panel-title {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-secondary);
    margin-bottom: 6px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .step-number {
    background: var(--accent);
    color: var(--bg-primary);
    font-size: 10px;
    font-weight: 800;
    padding: 1px 7px;
    border-radius: 10px;
    letter-spacing: 0;
  }

  /* Buttons */
  .btn {
    padding: 4px 10px;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: background 0.2s;
    white-space: nowrap;
  }
  .btn-primary { background: var(--accent); color: var(--bg-primary); }
  .btn-primary:hover { background: var(--accent-hover); }
  .btn-danger { background: var(--danger); color: white; }
  .btn-danger:hover { opacity: 0.9; }
  .btn-sm { padding: 3px 8px; font-size: 11px; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-outline {
    background: transparent;
    color: var(--accent);
    border: 1px solid var(--accent);
  }
  .btn-outline:hover { background: rgba(0,212,170,0.1); }
  .btn-group { display: flex; gap: 6px; margin-top: 6px; }
  .btn-icon {
    background: var(--bg-card);
    color: var(--text-primary);
    border: 1px solid var(--border);
    padding: 3px 8px;
    cursor: pointer;
    border-radius: var(--radius);
    font-size: 12px;
  }
  .btn-icon:hover { border-color: var(--accent); }

  /* Inputs */
  .input {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text-primary);
    padding: 4px 8px;
    font-size: 12px;
    width: 100%;
  }
  .input:focus { outline: none; border-color: var(--accent); }
  select.input { appearance: auto; }

  /* Field row compact */
  .field-row {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
    gap: 6px;
  }
  .field-row label {
    min-width: 60px;
    text-align: right;
    font-size: 11px;
    color: var(--text-secondary);
    flex-shrink: 0;
  }
  .field-row .input { flex: 1; }

  /* Two-column field grid */
  .field-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 4px 12px;
  }

  /* Sub-section */
  .sub-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 8px;
    margin-bottom: 6px;
  }
  .sub-section-title {
    font-size: 11px;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Server status inline */
  .server-inline {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
  }
  .server-inline .dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--text-secondary);
    flex-shrink: 0;
  }
  .server-inline .dot.running { background: var(--success); }

  /* Mini log */
  .mini-log {
    background: var(--bg-primary);
    border-radius: 4px;
    padding: 4px 6px;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 10px;
    line-height: 1.4;
    max-height: 42px;
    overflow-y: auto;
    color: var(--text-secondary);
    margin-top: 4px;
  }

  /* Scenario list compact */
  .scenario-list {
    max-height: 120px;
    overflow-y: auto;
  }
  .scenario-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 4px 8px;
    margin-bottom: 3px;
    cursor: pointer;
    transition: border-color 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .scenario-item:hover { border-color: var(--accent); }
  .scenario-item.selected { border-color: var(--accent); background: var(--bg-card); }
  .scenario-id { font-size: 10px; color: var(--accent); font-weight: 600; white-space: nowrap; }
  .scenario-name { font-size: 12px; flex: 1; }
  .scenario-meta { font-size: 10px; color: var(--text-secondary); white-space: nowrap; }

  /* Drop zone compact */
  .drop-zone {
    border: 1px dashed var(--border);
    border-radius: var(--radius);
    padding: 8px;
    text-align: center;
    color: var(--text-secondary);
    font-size: 11px;
    cursor: pointer;
    transition: border-color 0.2s;
    margin-bottom: 4px;
  }
  .drop-zone:hover, .drop-zone.dragover {
    border-color: var(--accent);
    background: rgba(0,212,170,0.05);
  }
  .drop-zone input[type="file"] { display: none; }

  .doc-list { list-style: none; max-height: 50px; overflow-y: auto; }
  .doc-item {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    padding: 2px 0;
    color: var(--text-secondary);
  }
  .doc-item .name { color: var(--text-primary); }

  /* Progress bar */
  .progress-container {
    background: var(--bg-secondary);
    border-radius: var(--radius);
    height: 20px;
    overflow: hidden;
    margin-bottom: 8px;
    position: relative;
  }
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #00b894);
    transition: width 0.3s ease;
    border-radius: var(--radius);
  }
  .progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 10px;
    font-weight: 600;
    color: var(--text-primary);
  }

  /* Step results */
  .step-list {
    list-style: none;
    max-height: 80px;
    overflow-y: auto;
  }
  .step-item {
    background: var(--bg-secondary);
    border-radius: 4px;
    padding: 4px 8px;
    margin-bottom: 3px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    border-left: 3px solid var(--border);
  }
  .step-item.passed { border-left-color: var(--success); }
  .step-item.failed { border-left-color: var(--danger); }
  .step-item.running { border-left-color: var(--warning); }
  .step-badge {
    font-size: 10px;
    font-weight: 700;
    min-width: 16px;
    text-align: center;
  }
  .step-badge.passed { color: var(--success); }
  .step-badge.failed { color: var(--danger); }
  .step-badge.running { color: var(--warning); }
  .step-desc { flex: 1; }
  .step-error {
    font-size: 10px;
    color: var(--danger);
    margin-top: 2px;
    padding-left: 24px;
  }

  /* Execution bottom: screenshot + log */
  .exec-bottom {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
    background: var(--border);
    flex: 1;
    min-height: 0;
  }

  .screenshot-container {
    background: var(--bg-secondary);
    overflow: hidden;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .screenshot-container img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }
  .screenshot-placeholder {
    color: var(--text-secondary);
    font-size: 12px;
  }

  .log-area {
    background: var(--bg-secondary);
    padding: 6px 8px;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 10px;
    line-height: 1.5;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-all;
    height: 100%;
  }
  .log-info { color: var(--text-primary); }
  .log-success { color: var(--success); }
  .log-warning { color: var(--warning); }
  .log-error { color: var(--danger); }
  .log-server { color: #6c9bd4; }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    max-width: 500px;
    width: 90%;
    max-height: 70vh;
    overflow-y: auto;
  }
  .modal h3 {
    font-size: 14px;
    margin-bottom: 12px;
    color: var(--accent);
  }
  .modal-context {
    background: var(--bg-primary);
    border-radius: var(--radius);
    padding: 10px;
    margin-bottom: 12px;
    font-size: 12px;
    line-height: 1.5;
    max-height: 200px;
    overflow-y: auto;
  }
  .modal-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  /* Folder browser modal */
  .folder-modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    max-width: 420px;
    width: 90%;
    max-height: 60vh;
    display: flex;
    flex-direction: column;
  }
  .folder-modal h3 {
    font-size: 14px;
    margin-bottom: 8px;
    color: var(--accent);
  }
  .folder-path {
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 8px;
    word-break: break-all;
    padding: 4px 8px;
    background: var(--bg-primary);
    border-radius: 4px;
  }
  .folder-list {
    flex: 1;
    overflow-y: auto;
    min-height: 120px;
    max-height: 300px;
  }
  .folder-item {
    padding: 6px 10px;
    cursor: pointer;
    font-size: 12px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .folder-item:hover { background: var(--bg-card); }
  .folder-item.parent { color: var(--accent); font-weight: 600; }
  .folder-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 12px;
  }

  /* Recent paths dropdown */
  .recent-dropdown {
    position: relative;
    display: inline-block;
  }
  .recent-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    z-index: 100;
    max-height: 120px;
    overflow-y: auto;
    display: none;
  }
  .recent-list.show { display: block; }
  .recent-item {
    padding: 4px 8px;
    font-size: 11px;
    cursor: pointer;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .recent-item:hover { background: var(--bg-card); color: var(--text-primary); }

  /* Responsive */
  @media (max-width: 1100px) {
    .top-row { grid-template-columns: 1fr; }
    .exec-bottom { grid-template-columns: 1fr; }
    body { overflow: auto; }
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <h1><span>AAT</span> ëŒ€ì‹œë³´ë“œ</h1>
  <div class="header-status">
    <span id="wsStatus">ì—°ê²° ëŠê¹€</span>
    <span class="status-dot" id="wsDot"></span>
  </div>
</div>

<!-- 3-Step Z-Pattern Layout -->
<div class="layout">

  <!-- TOP ROW: Step 1 (ì„¤ì •) + Step 2 (ì¤€ë¹„) -->
  <div class="top-row">

    <!-- STEP 1: ì„¤ì • -->
    <div class="panel">
      <div class="panel-title">
        <span class="step-number">1</span> ì„¤ì •
      </div>

      <!-- ì„œë²„ ê´€ë¦¬ -->
      <div class="sub-section">
        <div class="sub-section-title">ì„œë²„ ê´€ë¦¬</div>
        <!-- Row 1: ì„œë²„ ìœ í˜• + í¬íŠ¸ + ì‹œì‘/ì¤‘ì§€ + ìƒíƒœ -->
        <div class="field-row">
          <label>ì„œë²„ ìœ í˜•</label>
          <select class="input" id="serverType" onchange="onServerTypeChange()" style="flex:1.5">
            <option value="python">Python (http.server)</option>
            <option value="nodejs">Node.js (npx serve)</option>
            <option value="react">React (npm start)</option>
            <option value="nextjs">Next.js (npm run dev)</option>
            <option value="vue">Vue (npm run serve)</option>
            <option value="flask">Flask</option>
            <option value="django">Django</option>
            <option value="custom">ì§ì ‘ ì…ë ¥</option>
          </select>
          <label style="min-width:30px">í¬íŠ¸</label>
          <input class="input" id="serverPort" value="8000" style="width:60px;flex:0" onchange="onPortChange()">
          <button class="btn btn-primary btn-sm" id="btnServerStart" onclick="startServer()">ì‹œì‘</button>
          <button class="btn btn-danger btn-sm" id="btnServerStop" onclick="stopServer()" disabled>ì¤‘ì§€</button>
          <div class="server-inline">
            <span class="dot" id="serverDot"></span>
            <span id="serverStatusText">ì¤‘ì§€ë¨</span>
          </div>
        </div>
        <!-- Custom command (hidden by default) -->
        <div class="field-row" id="customCmdRow" style="display:none">
          <label>ëª…ë ¹ì–´</label>
          <input class="input" id="serverCmd" placeholder="custom command --port 3000">
        </div>
        <!-- Row 2: CWD path + browse + recent -->
        <div class="field-row">
          <label>ê²½ë¡œ</label>
          <div style="flex:1;position:relative">
            <div style="display:flex;gap:4px">
              <input class="input" id="serverCwd" placeholder="/path/to/project" style="flex:1">
              <button class="btn-icon" onclick="openFolderBrowser()" title="í´ë” íƒìƒ‰">ğŸ“</button>
              <button class="btn-icon" onclick="toggleRecentPaths()" title="ìµœê·¼ ì‚¬ìš©">â–¾</button>
            </div>
            <div class="recent-list" id="recentPathsList"></div>
          </div>
        </div>
        <div class="mini-log" id="serverMiniLog"></div>
      </div>

      <!-- í…ŒìŠ¤íŠ¸ ì„¤ì • -->
      <div class="sub-section">
        <div class="sub-section-title">í…ŒìŠ¤íŠ¸ ì„¤ì •</div>
        <div class="field-grid">
          <div class="field-row">
            <label>ì—”ì§„</label>
            <select class="input" id="cfgEngine">
              <option value="web">web</option>
              <option value="desktop">desktop</option>
            </select>
          </div>
          <div class="field-row">
            <label>ë¸Œë¼ìš°ì €</label>
            <select class="input" id="cfgBrowser">
              <option value="chromium">chromium</option>
              <option value="firefox">firefox</option>
              <option value="webkit">webkit</option>
            </select>
          </div>
          <div class="field-row">
            <label>í—¤ë“œë¦¬ìŠ¤</label>
            <select class="input" id="cfgHeadless">
              <option value="false">No</option>
              <option value="true">Yes</option>
            </select>
          </div>
          <div class="field-row">
            <label>ìŠ¹ì¸ ë°©ì‹</label>
            <select class="input" id="cfgApproval">
              <option value="manual">manual</option>
              <option value="branch">branch</option>
              <option value="auto">auto</option>
            </select>
          </div>
          <div class="field-row">
            <label>AI ì œê³µì</label>
            <select class="input" id="cfgProvider" onchange="onProviderChange()">
              <option value="claude">claude</option>
              <option value="openai">openai</option>
              <option value="ollama">ollama</option>
            </select>
          </div>
          <div class="field-row">
            <label>ëª¨ë¸</label>
            <select class="input" id="cfgModel" onchange="onModelSelect()">
            </select>
          </div>
        </div>
        <!-- Custom model input (hidden) -->
        <div class="field-row" id="customModelRow" style="display:none">
          <label>ëª¨ë¸ëª…</label>
          <input class="input" id="cfgModelCustom" placeholder="ëª¨ë¸ëª… ì§ì ‘ ì…ë ¥">
        </div>
        <!-- API Key (hidden for ollama) -->
        <div class="field-row" id="apiKeyRow">
          <label>API í‚¤</label>
          <input class="input" id="cfgApiKey" type="password" placeholder="***">
        </div>
        <div class="field-row">
          <label>ëŒ€ìƒ URL</label>
          <input class="input" id="cfgUrl" value="">
        </div>
        <div style="text-align:right;margin-top:4px">
          <button class="btn btn-primary btn-sm" onclick="saveConfig()">ì„¤ì • ì €ì¥</button>
        </div>
      </div>
    </div>

    <!-- STEP 2: ì¤€ë¹„ -->
    <div class="panel">
      <div class="panel-title">
        <span class="step-number">2</span> ì¤€ë¹„
      </div>

      <!-- ì‹œë‚˜ë¦¬ì˜¤ -->
      <div class="sub-section">
        <div class="sub-section-title">ì‹œë‚˜ë¦¬ì˜¤ <span id="scenarioCount" style="font-weight:400; color: var(--text-secondary); text-transform: none; letter-spacing: 0;"></span></div>
        <div class="field-row">
          <label>ê²½ë¡œ</label>
          <input class="input" id="scenarioPath" placeholder="scenarios/">
          <button class="btn btn-primary btn-sm" onclick="loadScenariosFromPath()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        <div class="scenario-list" id="scenarioList">
          <div style="color: var(--text-secondary); font-size: 12px; padding: 8px; text-align: center;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
        <div style="display:flex;gap:6px;margin-top:4px;align-items:center;flex-wrap:wrap">
          <button class="btn btn-outline btn-sm" onclick="loadScenarios()">ìƒˆë¡œê³ ì¹¨</button>
          <button class="btn btn-outline btn-sm" onclick="selectAllScenarios()">ì „ì²´ì„ íƒ</button>
          <button class="btn btn-outline btn-sm" onclick="clearScenarioSelection()">ì´ˆê¸°í™”</button>
          <span style="flex:1"></span>
          <input type="file" id="scenarioFileInput" accept=".yaml,.yml" multiple style="display:none">
          <button class="btn btn-outline btn-sm" onclick="document.getElementById('scenarioFileInput').click()">íŒŒì¼ ì„ íƒ</button>
          <button class="btn btn-primary btn-sm" onclick="uploadScenario()">ì—…ë¡œë“œ</button>
        </div>
      </div>

      <!-- ë¬¸ì„œ -->
      <div class="sub-section">
        <div class="sub-section-title">ë¬¸ì„œ</div>
        <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
          íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ
          <input type="file" id="fileInput" multiple accept=".md,.txt,.pdf,.html,.rst,.yaml,.yml,.json">
        </div>
        <ul class="doc-list" id="docList"></ul>
        <div class="btn-group" style="margin-top:4px">
          <button class="btn btn-primary btn-sm" onclick="uploadFiles()">ì—…ë¡œë“œ</button>
          <button class="btn btn-outline btn-sm" onclick="analyzeAndGenerate()">ë¶„ì„ ë° ìƒì„±</button>
        </div>
      </div>
    </div>

  </div><!-- /top-row -->

  <!-- STEP 3: ì‹¤í–‰ (full width) -->
  <div class="bottom-row">
    <div class="panel" style="flex-shrink:0; padding-bottom:4px">
      <div class="panel-title">
        <span class="step-number">3</span> ì‹¤í–‰
      </div>

      <!-- Controls -->
      <div style="display: flex; gap: 6px; margin-bottom: 6px; flex-wrap: wrap; align-items: center;">
        <button class="btn btn-primary" id="btnRun" onclick="startRun()">í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì „ì²´)</button>
        <button class="btn btn-primary" id="btnLoop" onclick="startLoop()">DevQA ë°˜ë³µ (ì „ì²´)</button>
        <button class="btn btn-danger" id="btnStop" onclick="stopRun()" disabled>ì¤‘ì§€</button>
        <div id="summary" style="display: none; margin-left: 8px; padding: 4px 12px; background: var(--bg-secondary); border-radius: var(--radius); font-size: 12px;"></div>
      </div>

      <!-- Progress -->
      <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        <div class="progress-text" id="progressText">0 / 0</div>
      </div>

      <!-- Step Results -->
      <ul class="step-list" id="stepList"></ul>
    </div>

    <!-- Bottom split: Screenshot + Log -->
    <div class="exec-bottom">
      <div style="padding:6px;background:var(--bg-primary);display:flex;flex-direction:column;min-height:0">
        <div class="panel-title" style="margin-bottom:4px">ì‹¤ì‹œê°„ ìŠ¤í¬ë¦°ìƒ·</div>
        <div class="screenshot-container" id="screenshotBox" style="flex:1;min-height:0">
          <div class="screenshot-placeholder">ìŠ¤í¬ë¦°ìƒ· ëŒ€ê¸° ì¤‘</div>
        </div>
      </div>
      <div style="padding:6px;background:var(--bg-primary);display:flex;flex-direction:column;min-height:0">
        <div class="panel-title" style="margin-bottom:4px">ì´ë²¤íŠ¸ ë¡œê·¸</div>
        <div class="log-area" id="logArea" style="flex:1;min-height:0"></div>
      </div>
    </div>
  </div><!-- /bottom-row -->

</div><!-- /layout -->

<!-- ìŠ¹ì¸ ëª¨ë‹¬ -->
<div class="modal-overlay" id="approvalModal">
  <div class="modal">
    <h3>AI ìˆ˜ì • ìŠ¹ì¸</h3>
    <div class="modal-context" id="approvalContext"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="resolvePrompt('approve')">ìŠ¹ì¸</button>
      <button class="btn btn-danger" onclick="resolvePrompt('deny')">ê±°ë¶€</button>
      <button class="btn btn-outline" onclick="resolvePrompt('approve_all')">ì „ì²´ ìŠ¹ì¸</button>
    </div>
  </div>
</div>

<!-- í´ë” íƒìƒ‰ ëª¨ë‹¬ -->
<div class="modal-overlay" id="folderModal">
  <div class="folder-modal">
    <h3>í´ë” íƒìƒ‰</h3>
    <div class="folder-path" id="folderCurrentPath"></div>
    <div class="folder-list" id="folderList"></div>
    <div class="folder-actions">
      <button class="btn btn-outline btn-sm" onclick="closeFolderBrowser()">ì·¨ì†Œ</button>
      <button class="btn btn-primary btn-sm" onclick="selectFolder()">ì„ íƒ</button>
    </div>
  </div>
</div>

<script>
// -- State --
let ws = null;
let isRunning = false;
let serverRunning = false;
let selectedScenarios = new Set();
let totalScenarios = 0;
let allScenarioIds = [];
let pendingFiles = [];
let folderBrowsePath = '';
let urlManuallySet = false;

// -- Server type presets --
const SERVER_PRESETS = {
  python:  (port) => `python3 -m http.server ${port}`,
  nodejs:  (port) => `npx serve -l ${port}`,
  react:   (port) => `PORT=${port} npm start`,
  nextjs:  (port) => `PORT=${port} npm run dev`,
  vue:     (port) => `PORT=${port} npm run serve`,
  flask:   (port) => `python3 -m flask run --port ${port}`,
  django:  (port) => `python3 manage.py runserver 0.0.0.0:${port}`,
};

// -- Provider â†” Model mapping --
const MODEL_OPTIONS = {
  claude: [
    { value: 'claude-sonnet-4-20250514', label: 'Claude Sonnet 4' },
    { value: 'claude-haiku-4-5-20251001', label: 'Claude Haiku 4.5' },
    { value: 'claude-opus-4-6', label: 'Claude Opus 4.6' },
  ],
  openai: [
    { value: 'gpt-4o', label: 'GPT-4o' },
    { value: 'gpt-4o-mini', label: 'GPT-4o Mini' },
    { value: 'gpt-4-turbo', label: 'GPT-4 Turbo' },
  ],
  ollama: [
    { value: 'codellama:7b', label: 'CodeLlama 7B' },
    { value: 'llama3:8b', label: 'Llama 3 8B' },
    { value: 'mistral:7b', label: 'Mistral 7B' },
    { value: 'custom', label: 'ì§ì ‘ ì…ë ¥' },
  ],
};

// -- Recent paths (localStorage) --
function getRecentPaths() {
  try {
    return JSON.parse(localStorage.getItem('aat_recent_paths') || '[]');
  } catch { return []; }
}

function addRecentPath(path) {
  if (!path) return;
  let paths = getRecentPaths().filter(p => p !== path);
  paths.unshift(path);
  paths = paths.slice(0, 5);
  localStorage.setItem('aat_recent_paths', JSON.stringify(paths));
}

function toggleRecentPaths() {
  const list = document.getElementById('recentPathsList');
  const paths = getRecentPaths();
  if (list.classList.contains('show')) {
    list.classList.remove('show');
    return;
  }
  list.innerHTML = '';
  if (paths.length === 0) {
    list.innerHTML = '<div class="recent-item" style="color:var(--text-secondary)">ê¸°ë¡ ì—†ìŒ</div>';
  } else {
    paths.forEach(p => {
      const item = document.createElement('div');
      item.className = 'recent-item';
      item.textContent = p;
      item.onclick = () => {
        document.getElementById('serverCwd').value = p;
        list.classList.remove('show');
      };
      list.appendChild(item);
    });
  }
  list.classList.add('show');
}

// Close recent dropdown on outside click
document.addEventListener('click', (e) => {
  const list = document.getElementById('recentPathsList');
  if (list && !e.target.closest('#recentPathsList') && !e.target.closest('[onclick*="toggleRecentPaths"]')) {
    list.classList.remove('show');
  }
});

// -- Server type change --
function onServerTypeChange() {
  const type = document.getElementById('serverType').value;
  const customRow = document.getElementById('customCmdRow');
  customRow.style.display = type === 'custom' ? 'flex' : 'none';
}

function buildServerCommand() {
  const type = document.getElementById('serverType').value;
  const port = document.getElementById('serverPort').value || '8000';
  if (type === 'custom') {
    return document.getElementById('serverCmd').value.trim();
  }
  const fn = SERVER_PRESETS[type];
  return fn ? fn(port) : '';
}

// -- Port change â†’ URL auto-fill --
function onPortChange() {
  const port = document.getElementById('serverPort').value;
  if (port && !urlManuallySet) {
    document.getElementById('cfgUrl').value = `http://localhost:${port}`;
  }
}

// Track manual URL edits
document.addEventListener('DOMContentLoaded', () => {
  const urlInput = document.getElementById('cfgUrl');
  urlInput.addEventListener('input', () => { urlManuallySet = true; });
});

// -- Provider â†” Model --
function onProviderChange() {
  const provider = document.getElementById('cfgProvider').value;
  const modelSelect = document.getElementById('cfgModel');
  const apiKeyRow = document.getElementById('apiKeyRow');
  const customModelRow = document.getElementById('customModelRow');

  // Show/hide API key for ollama
  apiKeyRow.style.display = provider === 'ollama' ? 'none' : 'flex';

  // Populate model options
  const options = MODEL_OPTIONS[provider] || [];
  modelSelect.innerHTML = '';
  options.forEach(opt => {
    const o = document.createElement('option');
    o.value = opt.value;
    o.textContent = opt.label;
    modelSelect.appendChild(o);
  });

  // Hide custom model input
  customModelRow.style.display = 'none';
}

function onModelSelect() {
  const val = document.getElementById('cfgModel').value;
  const customRow = document.getElementById('customModelRow');
  customRow.style.display = val === 'custom' ? 'flex' : 'none';
}

function getSelectedModel() {
  const val = document.getElementById('cfgModel').value;
  if (val === 'custom') {
    return document.getElementById('cfgModelCustom').value.trim();
  }
  return val;
}

// -- Folder Browser --
async function openFolderBrowser() {
  const currentPath = document.getElementById('serverCwd').value.trim() || '';
  folderBrowsePath = currentPath;
  await loadFolderContents(currentPath);
  document.getElementById('folderModal').classList.add('active');
}

function closeFolderBrowser() {
  document.getElementById('folderModal').classList.remove('active');
}

function selectFolder() {
  document.getElementById('serverCwd').value = folderBrowsePath;
  addRecentPath(folderBrowsePath);
  closeFolderBrowser();
}

async function loadFolderContents(path) {
  try {
    const url = '/api/browse?path=' + encodeURIComponent(path);
    const res = await fetch(url);
    const data = await res.json();
    folderBrowsePath = data.current || path;

    document.getElementById('folderCurrentPath').textContent = folderBrowsePath;

    const list = document.getElementById('folderList');
    list.innerHTML = '';

    // Parent dir
    if (data.parent && data.parent !== folderBrowsePath) {
      const parentItem = document.createElement('div');
      parentItem.className = 'folder-item parent';
      parentItem.innerHTML = 'â¬† ìƒìœ„ í´ë”';
      parentItem.onclick = () => loadFolderContents(data.parent);
      list.appendChild(parentItem);
    }

    // Sub-dirs
    if (data.dirs && data.dirs.length > 0) {
      data.dirs.forEach(dir => {
        const item = document.createElement('div');
        item.className = 'folder-item';
        item.innerHTML = `ğŸ“ ${escHtml(dir)}`;
        item.onclick = () => loadFolderContents(folderBrowsePath + '/' + dir);
        list.appendChild(item);
      });
    } else {
      const empty = document.createElement('div');
      empty.style.cssText = 'padding:8px;color:var(--text-secondary);font-size:11px;text-align:center';
      empty.textContent = 'í•˜ìœ„ í´ë” ì—†ìŒ';
      list.appendChild(empty);
    }
  } catch (e) {
    addLog('error', `í´ë” íƒìƒ‰ ì‹¤íŒ¨: ${e.message}`);
  }
}

// -- WebSocket --
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);

  ws.onopen = () => {
    document.getElementById('wsStatus').textContent = 'ì—°ê²°ë¨';
    document.getElementById('wsDot').classList.add('connected');
    addLog('info', 'WebSocket ì—°ê²°ë¨');
  };

  ws.onclose = () => {
    document.getElementById('wsStatus').textContent = 'ì—°ê²° ëŠê¹€';
    document.getElementById('wsDot').classList.remove('connected');
    addLog('warning', 'WebSocket ì—°ê²° ëŠê¹€, ì¬ì—°ê²° ì¤‘...');
    setTimeout(connectWS, 3000);
  };

  ws.onerror = () => {
    addLog('error', 'WebSocket ì˜¤ë¥˜');
  };

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    handleEvent(data);
  };

  setInterval(() => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'ping' }));
    }
  }, 30000);
}

function handleEvent(data) {
  switch (data.type) {
    case 'info': addLog('info', data.message); break;
    case 'success': addLog('success', data.message); break;
    case 'warning': addLog('warning', data.message); break;
    case 'error': addLog('error', data.message); break;
    case 'step_start':
      addStepRunning(data.step, data.total, data.description);
      break;
    case 'step_result':
      updateStepResult(data.step, data.passed, data.description, data.error);
      break;
    case 'progress':
      updateProgress(data.current, data.total, data.label);
      break;
    case 'screenshot':
      updateScreenshot(data.data);
      break;
    case 'section':
      addLog('info', `--- ${data.message || data.text} ---`);
      break;
    case 'prompt':
      showApprovalModal(data.question, data.options, data.context);
      break;
    case 'server_log':
      addServerLog(data.line);
      break;
    case 'server_exit':
      setServerRunning(false);
      addLog(data.return_code === 0 ? 'info' : 'warning',
        `ì„œë²„ ì¢…ë£Œ (ì½”ë“œ=${data.return_code})`);
      break;
    case 'run_start':
    case 'loop_start':
      setRunning(true);
      clearSteps();
      break;
    case 'run_complete':
    case 'loop_complete':
      setRunning(false);
      if (data.success !== undefined) showSummary(data);
      break;
    case 'run_cancelled':
    case 'loop_cancelled':
      setRunning(false);
      addLog('warning', 'ì‹¤í–‰ ì·¨ì†Œë¨');
      break;
    case 'run_error':
    case 'loop_error':
      setRunning(false);
      addLog('error', data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
      break;
    case 'pong': break;
    default: addLog('info', JSON.stringify(data));
  }
}

// -- Log --
function addLog(level, message) {
  const area = document.getElementById('logArea');
  const line = document.createElement('div');
  line.className = `log-${level}`;
  const time = new Date().toLocaleTimeString();
  line.textContent = `[${time}] ${message}`;
  area.appendChild(line);
  area.scrollTop = area.scrollHeight;
}

// -- Server Control --
function addServerLog(line) {
  const mini = document.getElementById('serverMiniLog');
  const el = document.createElement('div');
  el.textContent = line;
  mini.appendChild(el);
  while (mini.children.length > 3) {
    mini.removeChild(mini.firstChild);
  }
  mini.scrollTop = mini.scrollHeight;
  addLog('server', `[ì„œë²„] ${line}`);
}

function setServerRunning(running) {
  serverRunning = running;
  const dot = document.getElementById('serverDot');
  const text = document.getElementById('serverStatusText');
  const btnStart = document.getElementById('btnServerStart');
  const btnStop = document.getElementById('btnServerStop');

  if (running) {
    dot.classList.add('running');
    text.textContent = 'ì‹¤í–‰ ì¤‘';
    btnStart.disabled = true;
    btnStop.disabled = false;
  } else {
    dot.classList.remove('running');
    text.textContent = 'ì¤‘ì§€ë¨';
    btnStart.disabled = false;
    btnStop.disabled = true;
  }
}

async function startServer() {
  const command = buildServerCommand();
  const cwd = document.getElementById('serverCwd').value.trim();

  if (!command) {
    addLog('warning', 'ì„œë²„ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }

  // Save CWD to recent paths
  if (cwd) addRecentPath(cwd);

  try {
    const res = await fetch('/api/server/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ command, cwd }),
    });
    const data = await res.json();
    if (data.error) {
      addLog('error', data.error);
    } else {
      setServerRunning(true);
      addLog('success', 'ì„œë²„ ì‹œì‘ë¨ (PID: ' + (data.pid || '?') + ')');
      // Auto-fill URL
      const port = document.getElementById('serverPort').value;
      if (port && !urlManuallySet) {
        document.getElementById('cfgUrl').value = `http://localhost:${port}`;
        addLog('info', `URL ìë™ ì„¤ì •: http://localhost:${port}`);
      }
    }
  } catch (e) {
    addLog('error', `ì„œë²„ ì‹œì‘ ì‹¤íŒ¨: ${e.message}`);
  }
}

async function stopServer() {
  try {
    await fetch('/api/server/stop', { method: 'POST' });
    setServerRunning(false);
    document.getElementById('serverMiniLog').innerHTML = '';
    addLog('info', 'ì„œë²„ ì¤‘ì§€ë¨');
  } catch (e) {
    addLog('error', `ì„œë²„ ì¤‘ì§€ ì‹¤íŒ¨: ${e.message}`);
  }
}

async function checkServerStatus() {
  try {
    const res = await fetch('/api/server/status');
    const data = await res.json();
    setServerRunning(data.running);
  } catch (e) { /* ignore */ }
}

// -- Steps --
function clearSteps() {
  document.getElementById('stepList').innerHTML = '';
  document.getElementById('summary').style.display = 'none';
  const pc = document.getElementById('progressContainer');
  pc.style.display = 'block';
  updateProgress(0, 1, 'ì‹œì‘ ì¤‘...');
}

function addStepRunning(step, total, description) {
  const list = document.getElementById('stepList');
  const existing = document.getElementById(`step-${step}`);
  if (existing) existing.remove();

  const li = document.createElement('li');
  li.className = 'step-item running';
  li.id = `step-${step}`;
  li.innerHTML = `
    <span class="step-badge running">${step}</span>
    <span class="step-desc">${escHtml(description)}</span>
    <span style="color: var(--warning); font-size: 10px;">ì‹¤í–‰ ì¤‘...</span>
  `;
  list.appendChild(li);
  li.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function updateStepResult(step, passed, description, error) {
  const existing = document.getElementById(`step-${step}`);
  const status = passed ? 'passed' : 'failed';
  const badge = passed ? 'OK' : 'FAIL';

  if (existing) {
    existing.className = `step-item ${status}`;
    existing.innerHTML = `
      <span class="step-badge ${status}">${badge}</span>
      <span class="step-desc">${escHtml(description)}</span>
    `;
    if (error) {
      const errDiv = document.createElement('div');
      errDiv.className = 'step-error';
      errDiv.textContent = error;
      existing.appendChild(errDiv);
    }
  } else {
    const list = document.getElementById('stepList');
    const li = document.createElement('li');
    li.className = `step-item ${status}`;
    li.id = `step-${step}`;
    li.innerHTML = `
      <span class="step-badge ${status}">${badge}</span>
      <span class="step-desc">${escHtml(description)}</span>
    `;
    if (error) {
      const errDiv = document.createElement('div');
      errDiv.className = 'step-error';
      errDiv.textContent = error;
      li.appendChild(errDiv);
    }
    list.appendChild(li);
  }
}

// -- Progress --
function updateProgress(current, total, label) {
  const pct = total > 0 ? Math.round((current / total) * 100) : 0;
  document.getElementById('progressBar').style.width = `${pct}%`;
  document.getElementById('progressText').textContent = `${current} / ${total} â€” ${label || ''}`;
  document.getElementById('progressContainer').style.display = 'block';
}

// -- Screenshot --
function updateScreenshot(base64Data) {
  const box = document.getElementById('screenshotBox');
  box.innerHTML = `<img src="data:image/jpeg;base64,${base64Data}" alt="ì‹¤ì‹œê°„ ìŠ¤í¬ë¦°ìƒ·">`;
}

// -- Summary --
function showSummary(data) {
  const div = document.getElementById('summary');
  const status = data.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨';
  const color = data.success ? 'var(--success)' : 'var(--danger)';
  let html = `<span style="font-weight:700; color:${color};">${status}</span>`;
  if (data.iterations) html += ` | ${data.iterations}íšŒ`;
  if (data.duration_ms) html += ` | ${Math.round(data.duration_ms)}ms`;
  if (data.reason) html += ` | ${escHtml(data.reason)}`;
  div.innerHTML = html;
  div.style.display = 'inline-block';
}

// -- Approval Modal --
function showApprovalModal(question, options, context) {
  document.getElementById('approvalContext').textContent =
    context?.analysis || question || 'ì´ ìˆ˜ì •ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
  document.getElementById('approvalModal').classList.add('active');
}

function resolvePrompt(response) {
  document.getElementById('approvalModal').classList.remove('active');
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'prompt_response', response: response }));
  }
}

// -- Running state --
function setRunning(running) {
  isRunning = running;
  document.getElementById('btnRun').disabled = running;
  document.getElementById('btnLoop').disabled = running;
  document.getElementById('btnStop').disabled = !running;
}

// -- Document Upload --
function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function setupDropZone() {
  const zone = document.getElementById('dropZone');
  const input = document.getElementById('fileInput');

  zone.addEventListener('dragover', (e) => {
    e.preventDefault();
    zone.classList.add('dragover');
  });
  zone.addEventListener('dragleave', () => {
    zone.classList.remove('dragover');
  });
  zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
      pendingFiles = Array.from(e.dataTransfer.files);
      showPendingFiles();
    }
  });
  input.addEventListener('change', () => {
    if (input.files.length > 0) {
      pendingFiles = Array.from(input.files);
      showPendingFiles();
    }
  });
}

function showPendingFiles() {
  const zone = document.getElementById('dropZone');
  if (pendingFiles.length === 0) {
    zone.textContent = 'íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ';
    return;
  }
  const names = pendingFiles.map(f => f.name).join(', ');
  zone.textContent = `${pendingFiles.length}ê°œ íŒŒì¼ ì„ íƒë¨: ${names}`;
}

async function uploadFiles() {
  if (pendingFiles.length === 0) {
    addLog('warning', 'íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”');
    return;
  }

  const formData = new FormData();
  for (const f of pendingFiles) {
    formData.append('files', f);
  }

  try {
    const res = await fetch('/api/documents/upload', { method: 'POST', body: formData });
    const data = await res.json();
    if (data.error) {
      addLog('error', data.error);
    } else {
      addLog('success', `${data.count}ê°œ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ`);
      pendingFiles = [];
      showPendingFiles();
      loadDocuments();
    }
  } catch (e) {
    addLog('error', `ì—…ë¡œë“œ ì‹¤íŒ¨: ${e.message}`);
  }
}

async function loadDocuments() {
  try {
    const res = await fetch('/api/documents');
    const data = await res.json();
    const list = document.getElementById('docList');
    list.innerHTML = '';
    if (data.documents && data.documents.length > 0) {
      for (const doc of data.documents) {
        const li = document.createElement('li');
        li.className = 'doc-item';
        li.innerHTML = `<span class="name">${escHtml(doc.name)}</span><span>${formatSize(doc.size)}</span>`;
        list.appendChild(li);
      }
    }
  } catch (e) { /* ignore */ }
}

async function analyzeAndGenerate() {
  addLog('info', 'ë¶„ì„ ë° ìƒì„± â€” CLI ì‚¬ìš©: aat analyze / aat generate');
}

// -- Config --
async function loadConfig() {
  try {
    const res = await fetch('/api/config');
    const data = await res.json();
    if (data.engine) {
      document.getElementById('cfgEngine').value = data.engine.type || 'web';
      document.getElementById('cfgBrowser').value = data.engine.browser || 'chromium';
      document.getElementById('cfgHeadless').value = String(data.engine.headless || false);
    }
    if (data.ai) {
      document.getElementById('cfgProvider').value = data.ai.provider || 'claude';
      onProviderChange(); // populate model options
      // Try to set model to saved value
      const savedModel = data.ai.model || '';
      const modelSelect = document.getElementById('cfgModel');
      const matchingOption = Array.from(modelSelect.options).find(o => o.value === savedModel);
      if (matchingOption) {
        modelSelect.value = savedModel;
      } else if (savedModel) {
        // If saved model is not in presets, add it and select
        const customOpt = document.createElement('option');
        customOpt.value = savedModel;
        customOpt.textContent = savedModel;
        modelSelect.appendChild(customOpt);
        modelSelect.value = savedModel;
      }
      document.getElementById('cfgApiKey').placeholder = data.ai.api_key || '***';
    }
    document.getElementById('cfgUrl').value = data.url || '';
    document.getElementById('cfgApproval').value = data.approval_mode || 'manual';
  } catch (e) {
    addLog('error', `ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}`);
  }
}

async function saveConfig() {
  const body = {
    engine: {
      type: document.getElementById('cfgEngine').value,
      browser: document.getElementById('cfgBrowser').value,
      headless: document.getElementById('cfgHeadless').value === 'true',
    },
    ai: {
      provider: document.getElementById('cfgProvider').value,
      model: getSelectedModel(),
    },
    url: document.getElementById('cfgUrl').value,
    approval_mode: document.getElementById('cfgApproval').value,
  };
  const apiKey = document.getElementById('cfgApiKey').value;
  if (apiKey) body.ai.api_key = apiKey;

  try {
    const res = await fetch('/api/config', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await res.json();
    if (data.error) {
      addLog('error', `ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ${data.error}`);
    } else {
      addLog('success', 'ì„¤ì • ì €ì¥ ì™„ë£Œ');
      loadConfig();
    }
  } catch (e) {
    addLog('error', `ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ${e.message}`);
  }
}

// -- Scenarios --
function loadScenariosFromPath() {
  const path = document.getElementById('scenarioPath').value.trim();
  loadScenarios(path || undefined);
}

async function loadScenarios(customPath) {
  try {
    let url = '/api/scenarios';
    if (customPath) {
      url += '?path=' + encodeURIComponent(customPath);
    }
    const res = await fetch(url);
    const data = await res.json();
    const list = document.getElementById('scenarioList');
    allScenarioIds = [];

    if (!data.scenarios || data.scenarios.length === 0) {
      list.innerHTML = '<div style="color: var(--text-secondary); font-size: 12px; padding: 8px; text-align: center;">ì‹œë‚˜ë¦¬ì˜¤ ì—†ìŒ</div>';
      totalScenarios = 0;
      updateScenarioCount();
      if (data.error) addLog('warning', data.error);
      return;
    }

    totalScenarios = data.scenarios.length;
    list.innerHTML = '';
    data.scenarios.forEach(sc => {
      allScenarioIds.push(sc.id);
      const div = document.createElement('div');
      div.className = 'scenario-item' + (selectedScenarios.has(sc.id) ? ' selected' : '');
      div.innerHTML = `
        <span class="scenario-id">${escHtml(sc.id)}</span>
        <span class="scenario-name">${escHtml(sc.name)}</span>
        <span class="scenario-meta">${sc.steps_count}ë‹¨ê³„${sc.tags.length ? ' | ' + sc.tags.join(', ') : ''}</span>
      `;
      div.onclick = () => {
        if (selectedScenarios.has(sc.id)) {
          selectedScenarios.delete(sc.id);
          div.classList.remove('selected');
        } else {
          selectedScenarios.add(sc.id);
          div.classList.add('selected');
        }
        updateScenarioCount();
      };
      list.appendChild(div);
    });
    selectedScenarios.forEach(id => {
      if (!allScenarioIds.includes(id)) selectedScenarios.delete(id);
    });
    updateScenarioCount();

    if (data.error) addLog('warning', data.error);
    else addLog('info', `ì‹œë‚˜ë¦¬ì˜¤ ${totalScenarios}ê°œ ë¶ˆëŸ¬ì˜´`);
  } catch (e) {
    addLog('error', `ì‹œë‚˜ë¦¬ì˜¤ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}`);
  }
}

function updateScenarioCount() {
  const count = selectedScenarios.size;
  const el = document.getElementById('scenarioCount');
  if (totalScenarios > 0) {
    el.textContent = count > 0 ? `(${totalScenarios}ê°œ ì¤‘ ${count}ê°œ ì„ íƒë¨)` : `(${totalScenarios}ê°œ)`;
  } else {
    el.textContent = '';
  }
  const runLabel = count > 0 ? `í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (${count}ê°œ)` : 'í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì „ì²´)';
  const loopLabel = count > 0 ? `DevQA ë°˜ë³µ (${count}ê°œ)` : 'DevQA ë°˜ë³µ (ì „ì²´)';
  document.getElementById('btnRun').textContent = runLabel;
  document.getElementById('btnLoop').textContent = loopLabel;
}

function selectAllScenarios() {
  allScenarioIds.forEach(id => selectedScenarios.add(id));
  document.querySelectorAll('.scenario-item').forEach(el => el.classList.add('selected'));
  updateScenarioCount();
}

function clearScenarioSelection() {
  selectedScenarios.clear();
  document.querySelectorAll('.scenario-item').forEach(el => el.classList.remove('selected'));
  updateScenarioCount();
}

async function uploadScenario() {
  const input = document.getElementById('scenarioFileInput');
  if (!input.files || input.files.length === 0) {
    addLog('warning', 'ì‹œë‚˜ë¦¬ì˜¤ íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”');
    return;
  }

  // Upload each file
  let successCount = 0;
  for (const file of input.files) {
    const formData = new FormData();
    formData.append('file', file);
    try {
      const res = await fetch('/api/scenarios/upload', {
        method: 'POST',
        body: formData,
      });
      const data = await res.json();
      if (data.error) {
        addLog('error', `${file.name}: ${data.error}`);
      } else {
        successCount++;
        addLog('success', `ì‹œë‚˜ë¦¬ì˜¤ ì—…ë¡œë“œ ì™„ë£Œ: ${data.uploaded}`);
      }
    } catch (e) {
      addLog('error', `ì‹œë‚˜ë¦¬ì˜¤ ì—…ë¡œë“œ ì‹¤íŒ¨ (${file.name}): ${e.message}`);
    }
  }

  input.value = '';
  if (successCount > 0) {
    loadScenarios();
  }
}

// -- Run / Loop / Stop --
async function startRun() {
  const ids = [...selectedScenarios];
  try {
    const res = await fetch('/api/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ scenario_ids: ids }),
    });
    const data = await res.json();
    if (data.error) {
      addLog('error', data.error);
    } else {
      const label = ids.length > 0 ? `${ids.length}ê°œ ì‹œë‚˜ë¦¬ì˜¤` : 'ì „ì²´ ì‹œë‚˜ë¦¬ì˜¤';
      addLog('info', `í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œì‘ (${label})`);
    }
  } catch (e) {
    addLog('error', `í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨: ${e.message}`);
  }
}

async function startLoop() {
  const approvalMode = document.getElementById('cfgApproval').value;
  const ids = [...selectedScenarios];
  try {
    const res = await fetch('/api/loop', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ approval_mode: approvalMode, scenario_ids: ids }),
    });
    const data = await res.json();
    if (data.error) {
      addLog('error', data.error);
    } else {
      const label = ids.length > 0 ? `${ids.length}ê°œ ì‹œë‚˜ë¦¬ì˜¤` : 'ì „ì²´ ì‹œë‚˜ë¦¬ì˜¤';
      addLog('info', `DevQA ë°˜ë³µ ì‹œì‘ (${label})`);
    }
  } catch (e) {
    addLog('error', `DevQA ë°˜ë³µ ì‹¤íŒ¨: ${e.message}`);
  }
}

async function stopRun() {
  try {
    await fetch('/api/stop', { method: 'POST' });
    addLog('warning', 'ì¤‘ì§€ ìš”ì²­ë¨');
  } catch (e) {
    addLog('error', `ì¤‘ì§€ ì‹¤íŒ¨: ${e.message}`);
  }
}

function escHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

// -- Init --
document.addEventListener('DOMContentLoaded', () => {
  connectWS();
  loadConfig();
  loadScenarios();
  loadDocuments();
  checkServerStatus();
  setupDropZone();
  onProviderChange(); // initialize model options
});
</script>
</body>
</html>
