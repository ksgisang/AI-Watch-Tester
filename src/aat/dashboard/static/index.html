<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AAT Dashboard</title>
<style>
  :root {
    --bg-primary: #1a1a2e;
    --bg-secondary: #16213e;
    --bg-card: #0f3460;
    --text-primary: #e0e0e0;
    --text-secondary: #a0a0b0;
    --accent: #00d4aa;
    --accent-hover: #00f0c0;
    --danger: #e74c3c;
    --warning: #f39c12;
    --success: #00d4aa;
    --border: #2a2a4a;
    --radius: 8px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
  }

  /* Header */
  .header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    padding: 12px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .header h1 { font-size: 18px; font-weight: 600; }
  .header h1 span { color: var(--accent); }
  .header-status {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 13px;
  }
  .status-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--danger);
    display: inline-block;
  }
  .status-dot.connected { background: var(--success); }

  /* Layout: 3-step Z-pattern */
  .layout {
    display: flex;
    flex-direction: column;
    min-height: calc(100vh - 49px);
    gap: 1px;
    background: var(--border);
  }

  .top-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
  }

  .bottom-row {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg-primary);
  }

  .panel {
    background: var(--bg-primary);
    overflow-y: auto;
    padding: 16px;
  }

  .panel-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-secondary);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .step-number {
    background: var(--accent);
    color: var(--bg-primary);
    font-size: 10px;
    font-weight: 800;
    padding: 2px 8px;
    border-radius: 10px;
    letter-spacing: 0;
  }

  /* Buttons */
  .btn {
    padding: 8px 16px;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: background 0.2s;
  }
  .btn-primary {
    background: var(--accent);
    color: var(--bg-primary);
  }
  .btn-primary:hover { background: var(--accent-hover); }
  .btn-danger {
    background: var(--danger);
    color: white;
  }
  .btn-danger:hover { opacity: 0.9; }
  .btn-sm { padding: 5px 10px; font-size: 12px; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-outline {
    background: transparent;
    color: var(--accent);
    border: 1px solid var(--accent);
  }
  .btn-outline:hover { background: rgba(0,212,170,0.1); }

  .btn-group { display: flex; gap: 8px; margin-top: 12px; }

  /* Inputs */
  .input {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text-primary);
    padding: 6px 10px;
    font-size: 13px;
    width: 100%;
  }
  .input:focus { outline: none; border-color: var(--accent); }
  select.input { appearance: auto; }

  /* Field row: label + input side by side */
  .field-row {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    gap: 8px;
  }
  .field-row label {
    min-width: 70px;
    text-align: right;
    font-size: 11px;
    color: var(--text-secondary);
    flex-shrink: 0;
  }
  .field-row .input { flex: 1; }

  /* Sub-section */
  .sub-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px;
    margin-bottom: 12px;
  }
  .sub-section-title {
    font-size: 11px;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Server status indicator */
  .server-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    margin-bottom: 8px;
  }
  .server-status .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--text-secondary);
  }
  .server-status .dot.running { background: var(--success); }

  /* Mini log */
  .mini-log {
    background: var(--bg-primary);
    border-radius: 4px;
    padding: 6px 8px;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 10px;
    line-height: 1.5;
    max-height: 64px;
    overflow-y: auto;
    color: var(--text-secondary);
    margin-top: 8px;
  }

  /* Scenario list */
  .scenario-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 10px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  .scenario-item:hover { border-color: var(--accent); }
  .scenario-item.selected { border-color: var(--accent); background: var(--bg-card); }
  .scenario-id { font-size: 11px; color: var(--accent); font-weight: 600; }
  .scenario-name { font-size: 13px; margin-top: 2px; }
  .scenario-meta { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }

  /* Drop zone */
  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 16px;
    text-align: center;
    color: var(--text-secondary);
    font-size: 12px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    margin-bottom: 8px;
  }
  .drop-zone:hover, .drop-zone.dragover {
    border-color: var(--accent);
    background: rgba(0,212,170,0.05);
  }
  .drop-zone input[type="file"] { display: none; }

  .doc-list {
    list-style: none;
    max-height: 100px;
    overflow-y: auto;
  }
  .doc-item {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    padding: 3px 0;
    color: var(--text-secondary);
  }
  .doc-item .name { color: var(--text-primary); }

  /* Progress bar */
  .progress-container {
    background: var(--bg-secondary);
    border-radius: var(--radius);
    height: 24px;
    overflow: hidden;
    margin-bottom: 16px;
    position: relative;
  }
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #00b894);
    transition: width 0.3s ease;
    border-radius: var(--radius);
  }
  .progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 11px;
    font-weight: 600;
    color: var(--text-primary);
  }

  /* Step results */
  .step-list { list-style: none; }
  .step-item {
    background: var(--bg-secondary);
    border-radius: var(--radius);
    padding: 10px 12px;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    border-left: 3px solid var(--border);
  }
  .step-item.passed { border-left-color: var(--success); }
  .step-item.failed { border-left-color: var(--danger); }
  .step-item.running { border-left-color: var(--warning); }
  .step-badge {
    font-size: 11px;
    font-weight: 700;
    min-width: 20px;
    text-align: center;
  }
  .step-badge.passed { color: var(--success); }
  .step-badge.failed { color: var(--danger); }
  .step-badge.running { color: var(--warning); }
  .step-desc { flex: 1; }
  .step-error {
    font-size: 11px;
    color: var(--danger);
    margin-top: 4px;
    padding-left: 30px;
  }

  /* Execution bottom area: screenshot + log */
  .exec-bottom {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
    background: var(--border);
    flex: 1;
    min-height: 250px;
  }

  /* Screenshot viewer */
  .screenshot-container {
    background: var(--bg-secondary);
    border-radius: var(--radius);
    overflow: hidden;
    text-align: center;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .screenshot-container img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius);
  }
  .screenshot-placeholder {
    color: var(--text-secondary);
    font-size: 13px;
  }

  /* Log panel */
  .log-area {
    background: var(--bg-secondary);
    border-radius: var(--radius);
    padding: 10px;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 11px;
    line-height: 1.6;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-all;
    height: 100%;
  }
  .log-info { color: var(--text-primary); }
  .log-success { color: var(--success); }
  .log-warning { color: var(--warning); }
  .log-error { color: var(--danger); }
  .log-server { color: #6c9bd4; }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }
  .modal h3 {
    font-size: 16px;
    margin-bottom: 16px;
    color: var(--accent);
  }
  .modal-context {
    background: var(--bg-primary);
    border-radius: var(--radius);
    padding: 12px;
    margin-bottom: 16px;
    font-size: 13px;
    line-height: 1.5;
    max-height: 300px;
    overflow-y: auto;
  }
  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }

  /* Responsive */
  @media (max-width: 1100px) {
    .top-row {
      grid-template-columns: 1fr;
    }
    .exec-bottom {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <h1><span>AAT</span> Dashboard</h1>
  <div class="header-status">
    <span id="wsStatus">Disconnected</span>
    <span class="status-dot" id="wsDot"></span>
  </div>
</div>

<!-- 3-Step Z-Pattern Layout -->
<div class="layout">

  <!-- TOP ROW: Step 1 (Setup) + Step 2 (Prepare) -->
  <div class="top-row">

    <!-- STEP 1: Setup -->
    <div class="panel">
      <div class="panel-title">
        <span class="step-number">1</span> Setup
      </div>

      <!-- Server Control -->
      <div class="sub-section">
        <div class="sub-section-title">Server Control</div>
        <div class="server-status">
          <span class="dot" id="serverDot"></span>
          <span id="serverStatusText">Stopped</span>
        </div>
        <div class="field-row">
          <label>Command</label>
          <input class="input" id="serverCmd" placeholder="npm run dev --port 3000">
        </div>
        <div class="field-row">
          <label>CWD</label>
          <input class="input" id="serverCwd" placeholder="/path/to/project">
        </div>
        <div class="btn-group" style="margin-top:8px">
          <button class="btn btn-primary btn-sm" id="btnServerStart" onclick="startServer()">Start</button>
          <button class="btn btn-danger btn-sm" id="btnServerStop" onclick="stopServer()" disabled>Stop</button>
        </div>
        <div class="mini-log" id="serverMiniLog"></div>
      </div>

      <!-- Configuration -->
      <div class="sub-section">
        <div class="sub-section-title">Configuration</div>
        <div class="field-row">
          <label>Engine</label>
          <select class="input" id="cfgEngine">
            <option value="web">web</option>
            <option value="desktop">desktop</option>
          </select>
        </div>
        <div class="field-row">
          <label>Browser</label>
          <select class="input" id="cfgBrowser">
            <option value="chromium">chromium</option>
            <option value="firefox">firefox</option>
            <option value="webkit">webkit</option>
          </select>
        </div>
        <div class="field-row">
          <label>Headless</label>
          <select class="input" id="cfgHeadless">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
        <div class="field-row">
          <label>Provider</label>
          <select class="input" id="cfgProvider">
            <option value="claude">claude</option>
            <option value="openai">openai</option>
            <option value="ollama">ollama</option>
          </select>
        </div>
        <div class="field-row">
          <label>Model</label>
          <input class="input" id="cfgModel" value="">
        </div>
        <div class="field-row">
          <label>API Key</label>
          <input class="input" id="cfgApiKey" type="password" placeholder="***">
        </div>
        <div class="field-row">
          <label>URL</label>
          <input class="input" id="cfgUrl" value="">
        </div>
        <div class="field-row">
          <label>Approval</label>
          <select class="input" id="cfgApproval">
            <option value="manual">manual</option>
            <option value="branch">branch</option>
            <option value="auto">auto</option>
          </select>
        </div>
        <div class="btn-group" style="margin-top:8px">
          <button class="btn btn-primary btn-sm" onclick="saveConfig()">Save Config</button>
        </div>
      </div>
    </div>

    <!-- STEP 2: Prepare -->
    <div class="panel">
      <div class="panel-title">
        <span class="step-number">2</span> Prepare
      </div>

      <!-- Scenarios -->
      <div class="sub-section">
        <div class="sub-section-title">Scenarios <span id="scenarioCount" style="font-weight:400; color: var(--text-secondary); text-transform: none; letter-spacing: 0;"></span></div>
        <div class="field-row">
          <label>Path</label>
          <input class="input" id="scenarioPath" placeholder="custom/scenarios/path">
          <button class="btn btn-primary btn-sm" onclick="loadScenarios(document.getElementById('scenarioPath').value.trim())">Load</button>
        </div>
        <div id="scenarioList">
          <div style="color: var(--text-secondary); font-size: 13px;">Loading...</div>
        </div>
        <div class="btn-group" style="margin-top:8px">
          <button class="btn btn-primary btn-sm" onclick="loadScenarios()">Refresh</button>
          <button class="btn btn-outline btn-sm" onclick="selectAllScenarios()">Select All</button>
          <button class="btn btn-outline btn-sm" onclick="clearScenarioSelection()">Clear</button>
        </div>
        <!-- Scenario YAML upload -->
        <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
          <input type="file" id="scenarioFileInput" accept=".yaml,.yml" style="font-size: 12px; color: var(--text-secondary);">
          <button class="btn btn-outline btn-sm" onclick="uploadScenario()">Upload</button>
        </div>
      </div>

      <!-- Documents -->
      <div class="sub-section">
        <div class="sub-section-title">Documents</div>
        <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
          Drop files here or click to browse
          <input type="file" id="fileInput" multiple accept=".md,.txt,.pdf,.html,.rst,.yaml,.yml,.json">
        </div>
        <ul class="doc-list" id="docList"></ul>
        <div class="btn-group" style="margin-top:8px">
          <button class="btn btn-primary btn-sm" onclick="uploadFiles()">Upload</button>
          <button class="btn btn-outline btn-sm" onclick="analyzeAndGenerate()">Analyze &amp; Generate</button>
        </div>
      </div>
    </div>

  </div><!-- /top-row -->

  <!-- STEP 3: Execute (full width) -->
  <div class="bottom-row">
    <div class="panel" style="flex-shrink:0">
      <div class="panel-title">
        <span class="step-number">3</span> Execute
      </div>

      <!-- Controls -->
      <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
        <button class="btn btn-primary" id="btnRun" onclick="startRun()">Run Test (All)</button>
        <button class="btn btn-primary" id="btnLoop" onclick="startLoop()">DevQA Loop (All)</button>
        <button class="btn btn-danger" id="btnStop" onclick="stopRun()" disabled>Stop</button>
        <div id="summary" style="display: none; margin-left: 16px; padding: 8px 16px; background: var(--bg-secondary); border-radius: var(--radius); font-size: 13px;"></div>
      </div>

      <!-- Progress -->
      <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        <div class="progress-text" id="progressText">0 / 0</div>
      </div>

      <!-- Step Results -->
      <ul class="step-list" id="stepList"></ul>
    </div>

    <!-- Bottom split: Screenshot + Log -->
    <div class="exec-bottom">
      <div class="panel">
        <div class="panel-title">Live Screenshot</div>
        <div class="screenshot-container" id="screenshotBox">
          <div class="screenshot-placeholder">No screenshot yet</div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-title">Event Log</div>
        <div class="log-area" id="logArea"></div>
      </div>
    </div>
  </div><!-- /bottom-row -->

</div><!-- /layout -->

<!-- Approval Modal -->
<div class="modal-overlay" id="approvalModal">
  <div class="modal">
    <h3>AI Fix Approval</h3>
    <div class="modal-context" id="approvalContext"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="resolvePrompt('approve')">Approve</button>
      <button class="btn btn-danger" onclick="resolvePrompt('deny')">Deny</button>
      <button class="btn btn-outline" onclick="resolvePrompt('approve_all')">Approve All</button>
    </div>
  </div>
</div>

<script>
// -- State --
let ws = null;
let isRunning = false;
let serverRunning = false;
let selectedScenarios = new Set();
let totalScenarios = 0;
let allScenarioIds = [];
let pendingFiles = [];

// -- WebSocket --
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);

  ws.onopen = () => {
    document.getElementById('wsStatus').textContent = 'Connected';
    document.getElementById('wsDot').classList.add('connected');
    addLog('info', 'WebSocket connected');
  };

  ws.onclose = () => {
    document.getElementById('wsStatus').textContent = 'Disconnected';
    document.getElementById('wsDot').classList.remove('connected');
    addLog('warning', 'WebSocket disconnected, reconnecting...');
    setTimeout(connectWS, 3000);
  };

  ws.onerror = () => {
    addLog('error', 'WebSocket error');
  };

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    handleEvent(data);
  };

  setInterval(() => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'ping' }));
    }
  }, 30000);
}

function handleEvent(data) {
  switch (data.type) {
    case 'info':
      addLog('info', data.message);
      break;
    case 'success':
      addLog('success', data.message);
      break;
    case 'warning':
      addLog('warning', data.message);
      break;
    case 'error':
      addLog('error', data.message);
      break;
    case 'step_start':
      addStepRunning(data.step, data.total, data.description);
      break;
    case 'step_result':
      updateStepResult(data.step, data.passed, data.description, data.error);
      break;
    case 'progress':
      updateProgress(data.current, data.total, data.label);
      break;
    case 'screenshot':
      updateScreenshot(data.data);
      break;
    case 'section':
      addLog('info', `--- ${data.message || data.text} ---`);
      break;
    case 'prompt':
      showApprovalModal(data.question, data.options, data.context);
      break;
    case 'server_log':
      addServerLog(data.line);
      break;
    case 'server_exit':
      setServerRunning(false);
      addLog(data.return_code === 0 ? 'info' : 'warning',
        `Server exited (code=${data.return_code})`);
      break;
    case 'run_start':
    case 'loop_start':
      setRunning(true);
      clearSteps();
      break;
    case 'run_complete':
    case 'loop_complete':
      setRunning(false);
      if (data.success !== undefined) {
        showSummary(data);
      }
      break;
    case 'run_cancelled':
    case 'loop_cancelled':
      setRunning(false);
      addLog('warning', 'Execution cancelled');
      break;
    case 'run_error':
    case 'loop_error':
      setRunning(false);
      addLog('error', data.error || 'Unknown error');
      break;
    case 'pong':
      break;
    default:
      addLog('info', JSON.stringify(data));
  }
}

// -- Log --
function addLog(level, message) {
  const area = document.getElementById('logArea');
  const line = document.createElement('div');
  line.className = `log-${level}`;
  const time = new Date().toLocaleTimeString();
  line.textContent = `[${time}] ${message}`;
  area.appendChild(line);
  area.scrollTop = area.scrollHeight;
}

// -- Server Control --
function addServerLog(line) {
  // Mini log (last 4 lines)
  const mini = document.getElementById('serverMiniLog');
  const el = document.createElement('div');
  el.textContent = line;
  mini.appendChild(el);
  while (mini.children.length > 4) {
    mini.removeChild(mini.firstChild);
  }
  mini.scrollTop = mini.scrollHeight;

  // Main event log with [server] prefix
  addLog('server', `[server] ${line}`);
}

function setServerRunning(running) {
  serverRunning = running;
  const dot = document.getElementById('serverDot');
  const text = document.getElementById('serverStatusText');
  const btnStart = document.getElementById('btnServerStart');
  const btnStop = document.getElementById('btnServerStop');

  if (running) {
    dot.classList.add('running');
    text.textContent = 'Running';
    btnStart.disabled = true;
    btnStop.disabled = false;
  } else {
    dot.classList.remove('running');
    text.textContent = 'Stopped';
    btnStart.disabled = false;
    btnStop.disabled = true;
  }
}

async function startServer() {
  const command = document.getElementById('serverCmd').value.trim();
  const cwd = document.getElementById('serverCwd').value.trim();

  if (!command) {
    addLog('warning', 'Enter a server command first');
    return;
  }

  try {
    const res = await fetch('/api/server/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ command, cwd }),
    });
    const data = await res.json();
    if (data.error) {
      addLog('error', data.error);
    } else {
      setServerRunning(true);
      addLog('success', 'Server started (PID: ' + (data.pid || '?') + ')');
      // Auto-fill URL if suggested
      if (data.suggested_url) {
        const urlInput = document.getElementById('cfgUrl');
        if (!urlInput.value) {
          urlInput.value = data.suggested_url;
          addLog('info', 'Auto-filled URL: ' + data.suggested_url);
        }
      }
    }
  } catch (e) {
    addLog('error', `Failed to start server: ${e.message}`);
  }
}

async function stopServer() {
  try {
    const res = await fetch('/api/server/stop', { method: 'POST' });
    const data = await res.json();
    setServerRunning(false);
    document.getElementById('serverMiniLog').innerHTML = '';
    addLog('info', 'Server stopped');
  } catch (e) {
    addLog('error', `Failed to stop server: ${e.message}`);
  }
}

async function checkServerStatus() {
  try {
    const res = await fetch('/api/server/status');
    const data = await res.json();
    setServerRunning(data.running);
  } catch (e) {
    // ignore
  }
}

// -- Steps --
function clearSteps() {
  document.getElementById('stepList').innerHTML = '';
  document.getElementById('summary').style.display = 'none';
  const pc = document.getElementById('progressContainer');
  pc.style.display = 'block';
  updateProgress(0, 1, 'Starting...');
}

function addStepRunning(step, total, description) {
  const list = document.getElementById('stepList');
  const existing = document.getElementById(`step-${step}`);
  if (existing) existing.remove();

  const li = document.createElement('li');
  li.className = 'step-item running';
  li.id = `step-${step}`;
  li.innerHTML = `
    <span class="step-badge running">${step}</span>
    <span class="step-desc">${escHtml(description)}</span>
    <span style="color: var(--warning); font-size: 11px;">running...</span>
  `;
  list.appendChild(li);
  li.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function updateStepResult(step, passed, description, error) {
  const existing = document.getElementById(`step-${step}`);
  const status = passed ? 'passed' : 'failed';
  const badge = passed ? 'OK' : 'FAIL';

  if (existing) {
    existing.className = `step-item ${status}`;
    existing.innerHTML = `
      <span class="step-badge ${status}">${badge}</span>
      <span class="step-desc">${escHtml(description)}</span>
    `;
    if (error) {
      const errDiv = document.createElement('div');
      errDiv.className = 'step-error';
      errDiv.textContent = error;
      existing.appendChild(errDiv);
    }
  } else {
    const list = document.getElementById('stepList');
    const li = document.createElement('li');
    li.className = `step-item ${status}`;
    li.id = `step-${step}`;
    li.innerHTML = `
      <span class="step-badge ${status}">${badge}</span>
      <span class="step-desc">${escHtml(description)}</span>
    `;
    if (error) {
      const errDiv = document.createElement('div');
      errDiv.className = 'step-error';
      errDiv.textContent = error;
      li.appendChild(errDiv);
    }
    list.appendChild(li);
  }
}

// -- Progress --
function updateProgress(current, total, label) {
  const pct = total > 0 ? Math.round((current / total) * 100) : 0;
  document.getElementById('progressBar').style.width = `${pct}%`;
  document.getElementById('progressText').textContent = `${current} / ${total} — ${label || ''}`;
  document.getElementById('progressContainer').style.display = 'block';
}

// -- Screenshot --
function updateScreenshot(base64Data) {
  const box = document.getElementById('screenshotBox');
  box.innerHTML = `<img src="data:image/jpeg;base64,${base64Data}" alt="Live screenshot">`;
}

// -- Summary --
function showSummary(data) {
  const div = document.getElementById('summary');
  const status = data.success ? 'SUCCESS' : 'FAILURE';
  const color = data.success ? 'var(--success)' : 'var(--danger)';
  let html = `<span style="font-weight:700; color:${color};">${status}</span>`;
  if (data.iterations) html += ` | ${data.iterations} iter`;
  if (data.duration_ms) html += ` | ${Math.round(data.duration_ms)}ms`;
  if (data.reason) html += ` | ${escHtml(data.reason)}`;
  div.innerHTML = html;
  div.style.display = 'inline-block';
}

// -- Approval Modal --
function showApprovalModal(question, options, context) {
  document.getElementById('approvalContext').textContent =
    context?.analysis || question || 'Approve this fix?';
  document.getElementById('approvalModal').classList.add('active');
}

function resolvePrompt(response) {
  document.getElementById('approvalModal').classList.remove('active');
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'prompt_response', response: response }));
  }
}

// -- Running state --
function setRunning(running) {
  isRunning = running;
  document.getElementById('btnRun').disabled = running;
  document.getElementById('btnLoop').disabled = running;
  document.getElementById('btnStop').disabled = !running;
}

// -- Document Upload --
function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function setupDropZone() {
  const zone = document.getElementById('dropZone');
  const input = document.getElementById('fileInput');

  zone.addEventListener('dragover', (e) => {
    e.preventDefault();
    zone.classList.add('dragover');
  });
  zone.addEventListener('dragleave', () => {
    zone.classList.remove('dragover');
  });
  zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
      pendingFiles = Array.from(e.dataTransfer.files);
      showPendingFiles();
    }
  });
  input.addEventListener('change', () => {
    if (input.files.length > 0) {
      pendingFiles = Array.from(input.files);
      showPendingFiles();
    }
  });
}

function showPendingFiles() {
  const zone = document.getElementById('dropZone');
  if (pendingFiles.length === 0) {
    zone.textContent = 'Drop files here or click to browse';
    return;
  }
  const names = pendingFiles.map(f => f.name).join(', ');
  zone.textContent = `${pendingFiles.length} file(s) selected: ${names}`;
}

async function uploadFiles() {
  if (pendingFiles.length === 0) {
    addLog('warning', 'No files selected');
    return;
  }

  const formData = new FormData();
  for (const f of pendingFiles) {
    formData.append('files', f);
  }

  try {
    const res = await fetch('/api/documents/upload', {
      method: 'POST',
      body: formData,
    });
    const data = await res.json();
    if (data.error) {
      addLog('error', data.error);
    } else {
      addLog('success', `Uploaded ${data.count} file(s)`);
      pendingFiles = [];
      showPendingFiles();
      loadDocuments();
    }
  } catch (e) {
    addLog('error', `Upload failed: ${e.message}`);
  }
}

async function loadDocuments() {
  try {
    const res = await fetch('/api/documents');
    const data = await res.json();
    const list = document.getElementById('docList');
    list.innerHTML = '';
    if (data.documents && data.documents.length > 0) {
      for (const doc of data.documents) {
        const li = document.createElement('li');
        li.className = 'doc-item';
        li.innerHTML = `<span class="name">${escHtml(doc.name)}</span><span>${formatSize(doc.size)}</span>`;
        list.appendChild(li);
      }
    }
  } catch (e) {
    // ignore
  }
}

async function analyzeAndGenerate() {
  addLog('info', 'Analyze & Generate — use CLI: aat analyze / aat generate');
}

// -- API Calls --
async function loadConfig() {
  try {
    const res = await fetch('/api/config');
    const data = await res.json();
    if (data.engine) {
      document.getElementById('cfgEngine').value = data.engine.type || 'web';
      document.getElementById('cfgBrowser').value = data.engine.browser || 'chromium';
      document.getElementById('cfgHeadless').value = String(data.engine.headless || false);
    }
    if (data.ai) {
      document.getElementById('cfgProvider').value = data.ai.provider || 'claude';
      document.getElementById('cfgModel').value = data.ai.model || '';
      document.getElementById('cfgApiKey').placeholder = data.ai.api_key || '***';
    }
    document.getElementById('cfgUrl').value = data.url || '';
    document.getElementById('cfgApproval').value = data.approval_mode || 'manual';
  } catch (e) {
    addLog('error', `Failed to load config: ${e.message}`);
  }
}

async function saveConfig() {
  const body = {
    engine: {
      type: document.getElementById('cfgEngine').value,
      browser: document.getElementById('cfgBrowser').value,
      headless: document.getElementById('cfgHeadless').value === 'true',
    },
    ai: {
      provider: document.getElementById('cfgProvider').value,
      model: document.getElementById('cfgModel').value,
    },
    url: document.getElementById('cfgUrl').value,
    approval_mode: document.getElementById('cfgApproval').value,
  };
  const apiKey = document.getElementById('cfgApiKey').value;
  if (apiKey) body.ai.api_key = apiKey;

  try {
    const res = await fetch('/api/config', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await res.json();
    if (data.error) {
      addLog('error', `Config save failed: ${data.error}`);
    } else {
      addLog('success', 'Config saved');
      loadConfig();
    }
  } catch (e) {
    addLog('error', `Config save failed: ${e.message}`);
  }
}

async function loadScenarios(customPath) {
  try {
    let url = '/api/scenarios';
    if (customPath) {
      url += '?path=' + encodeURIComponent(customPath);
    }
    const res = await fetch(url);
    const data = await res.json();
    const list = document.getElementById('scenarioList');
    allScenarioIds = [];
    if (!data.scenarios || data.scenarios.length === 0) {
      list.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px;">No scenarios found</div>';
      totalScenarios = 0;
      updateScenarioCount();
      return;
    }
    totalScenarios = data.scenarios.length;
    list.innerHTML = '';
    data.scenarios.forEach(sc => {
      allScenarioIds.push(sc.id);
      const div = document.createElement('div');
      div.className = 'scenario-item' + (selectedScenarios.has(sc.id) ? ' selected' : '');
      div.innerHTML = `
        <div class="scenario-id">${escHtml(sc.id)}</div>
        <div class="scenario-name">${escHtml(sc.name)}</div>
        <div class="scenario-meta">${sc.steps_count} steps${sc.tags.length ? ' | ' + sc.tags.join(', ') : ''}</div>
      `;
      div.onclick = () => {
        if (selectedScenarios.has(sc.id)) {
          selectedScenarios.delete(sc.id);
          div.classList.remove('selected');
        } else {
          selectedScenarios.add(sc.id);
          div.classList.add('selected');
        }
        updateScenarioCount();
      };
      list.appendChild(div);
    });
    // Remove selections not in current list
    selectedScenarios.forEach(id => {
      if (!allScenarioIds.includes(id)) selectedScenarios.delete(id);
    });
    updateScenarioCount();
    if (data.error) {
      addLog('warning', data.error);
    }
  } catch (e) {
    addLog('error', `Failed to load scenarios: ${e.message}`);
  }
}

function updateScenarioCount() {
  const count = selectedScenarios.size;
  const el = document.getElementById('scenarioCount');
  if (totalScenarios > 0) {
    el.textContent = count > 0 ? `(${count} / ${totalScenarios} selected)` : `(${totalScenarios} total)`;
  } else {
    el.textContent = '';
  }
  // Update button labels
  const runLabel = count > 0 ? `Run Test (${count})` : 'Run Test (All)';
  const loopLabel = count > 0 ? `DevQA Loop (${count})` : 'DevQA Loop (All)';
  document.getElementById('btnRun').textContent = runLabel;
  document.getElementById('btnLoop').textContent = loopLabel;
}

function selectAllScenarios() {
  allScenarioIds.forEach(id => selectedScenarios.add(id));
  // Re-render selection state
  document.querySelectorAll('.scenario-item').forEach(el => el.classList.add('selected'));
  updateScenarioCount();
}

function clearScenarioSelection() {
  selectedScenarios.clear();
  document.querySelectorAll('.scenario-item').forEach(el => el.classList.remove('selected'));
  updateScenarioCount();
}

async function uploadScenario() {
  const input = document.getElementById('scenarioFileInput');
  if (!input.files || input.files.length === 0) {
    addLog('warning', 'No scenario file selected');
    return;
  }
  const file = input.files[0];
  const formData = new FormData();
  formData.append('file', file);

  try {
    const res = await fetch('/api/scenarios/upload', {
      method: 'POST',
      body: formData,
    });
    const data = await res.json();
    if (data.error) {
      addLog('error', data.error);
    } else {
      addLog('success', `Scenario uploaded: ${data.uploaded}`);
      input.value = '';
      loadScenarios();
    }
  } catch (e) {
    addLog('error', `Scenario upload failed: ${e.message}`);
  }
}

async function startRun() {
  const ids = [...selectedScenarios];
  try {
    const res = await fetch('/api/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ scenario_ids: ids }),
    });
    const data = await res.json();
    if (data.error) {
      addLog('error', data.error);
    } else {
      const label = ids.length > 0 ? `${ids.length} scenario(s)` : 'all scenarios';
      addLog('info', `Test run started (${label})`);
    }
  } catch (e) {
    addLog('error', `Failed to start run: ${e.message}`);
  }
}

async function startLoop() {
  const approvalMode = document.getElementById('cfgApproval').value;
  const ids = [...selectedScenarios];
  try {
    const res = await fetch('/api/loop', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ approval_mode: approvalMode, scenario_ids: ids }),
    });
    const data = await res.json();
    if (data.error) {
      addLog('error', data.error);
    } else {
      const label = ids.length > 0 ? `${ids.length} scenario(s)` : 'all scenarios';
      addLog('info', `DevQA Loop started (${label})`);
    }
  } catch (e) {
    addLog('error', `Failed to start loop: ${e.message}`);
  }
}

async function stopRun() {
  try {
    await fetch('/api/stop', { method: 'POST' });
    addLog('warning', 'Stop requested');
  } catch (e) {
    addLog('error', `Failed to stop: ${e.message}`);
  }
}

function escHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

// -- Init --
document.addEventListener('DOMContentLoaded', () => {
  connectWS();
  loadConfig();
  loadScenarios();
  loadDocuments();
  checkServerStatus();
  setupDropZone();
});
</script>
</body>
</html>
